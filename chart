getplanttable() {
  if (this.selectedPlantIds.length === 0) {
    console.log('No plant IDs selected.');
    return;
  }

  const apiUrls = this.apiurl + '/ViewChangeRequest/ViewChangerequest';
  let queryParams = new HttpParams();

  if (this.selectedPlantIds.length > 0 && this.startDate && this.endDate) {
    queryParams = queryParams.set('plantId', this.selectedPlantIds.join(','));
    queryParams = queryParams.set('crdate', this.startDate + '-' + this.endDate);
  }

  const httpOptions = {
    headers: new HttpHeaders({
      'Content-Type': 'application/json'
    }),
    params: queryParams
  };

  this.http.get(apiUrls, httpOptions).subscribe(
    (response: any) => {
      console.log('Response:', response);
      this.chartdata = response;
      this.multi = [];

      const filteredResponse = response.filter((item: { plantId: string }) => this.selectedPlantIds.includes(item.plantId));
      console.log('Filtered Response:', filteredResponse);

      this.selectedPlantIds.forEach(selectedPlantId => {
        const plantData = filteredResponse.filter((item: { plantId: any; }) => item.plantId === selectedPlantId);
        console.log('Plant Data for', selectedPlantId, ':', plantData);

        const stagesCount: { [key: string]: number } = {};
        this.stagesToCount.forEach(stage => {
          stagesCount[stage] = plantData.filter((item: { stage: string; }) => item.stage.trim() === stage).length;
        });

        console.log('Stages Count for', selectedPlantId, ':', stagesCount);

        const plantSeries = {
          label: selectedPlantId,
          data: this.stagesToCount.map(stage => stagesCount[stage] || 0) // Ensure data is defined for each stage
        };

        console.log('Plant Series for', selectedPlantId, ':', plantSeries);

        this.multi.push(plantSeries);
      });

      console.log('Multi:', this.multi);

      this.updateOptions();
      this.showChart = true;
    },
    (error: any) => {
      console.error('Error fetching chart data:', error);
    }
  );
}

updateOptions() {
  this.chartOptions = {
    animationEnabled: true,
    exportEnabled: false,
    data: this.multi.map((plantSeries, index) => ({
      type: "stackedBar",
      name: plantSeries.label,
      showInLegend: true,
      color: this.getRandomColor(index),
      dataPoints: this.stagesToCount.map((stage, stageIndex) => ({
        y: plantSeries.data[stageIndex] || 0,
        label: stage
      }))
    })),
    axisX: {
      title: "Stages"
    },
    axisY: {
      title: "Total Changes",
      gridThickness: 0,
      includeZero: true
    },
    toolTip: {
      shared: true
    },
    legend: {
      dockInsidePlotArea: false,
      horizontalAlign: "center",
      verticalAlign: "top"
    }
  };

  console.log('Chart Options:', this.chartOptions);
}
