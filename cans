<div *ngIf="showChart">
  <canvas baseChart 
          [datasets]="chartOptions.data.datasets"
          [labels]="chartOptions.data.labels"
          [options]="chartOptions.options"
          [legend]="chartOptions.legend"
          [chartType]="chartOptions.chartType">
  </canvas>
</div>

getChartData() {
  const apiUrls = `${this.apiurl}/ViewChangeRequest/ViewChangerequest`;
  const httpOptions = {
    headers: new HttpHeaders({
      'Content-Type': 'application/json'
    })
  };

  // Define the stages you want to count
  const stagesToCount = ['Approval', 'Closure', 'Implementation', 'Initiated', 'Release'];

  this.http.get(apiUrls).subscribe(
    (response: any) => {
      this.chartdata = response;
      this.multi = [];

      const uniquePlants = [...new Set(response.map((item: { plantId: any; }) => item.plantId))];

      uniquePlants.forEach(plantId => {
        const plantData = response.filter((item: { plantId: any; }) => item.plantId === plantId);

        const stagesCount: { [key: string]: number } = {};
        stagesToCount.forEach(stage => {
          stagesCount[stage] = plantData.filter((item: { stage: string; }) => item.stage.trim() === stage).length;
        });

        const plantSeries = stagesToCount.map(stage => stagesCount[stage]);

        this.multi.push({
          label: plantId,
          data: plantSeries
        });
      });

      // Log the structured data
      console.log('Structured Data:', {
        labels: stagesToCount,
        datasets: this.multi.map((data, index) => ({
          label: data.label,
          backgroundColor: this.getRandomColor(), // You can define this method to generate random colors
          data: data.data
        }))
      });

      this.chartOptions = {
        animationEnabled: true,
        exportEnabled: true,
        title: {
          text: "Change Request - Plant-wise Report",
          fontFamily: "Calibri, Arial, sans-serif"
        },
        scales: {
          xAxes: [{
            scaleLabel: {
              display: true,
              labelString: 'Total Changes'
            },
            ticks: {
              beginAtZero: true
            }
          }],
          yAxes: [{
            scaleLabel: {
              display: true,
              labelString: 'Plant ID'
            }
          }]
        },
        tooltips: {
          mode: 'label',
          intersect: false,
          displayColors: false
        },
        legend: {
          display: true
        },
        data: {
          labels: stagesToCount,
          datasets: this.multi.map((data, index) => ({
            label: data.label,
            backgroundColor: this.getRandomColor(), // You can define this method to generate random colors
            data: data.data
          }))
        }
      };

      this.showChart = true; 
    },
    (error: any) => {
      console.error('Error fetching chart data:', error);
    }
  );
}
