import { HttpClient, HttpHeaders } from '@angular/common/http';
import { Component, OnInit, ViewChild } from '@angular/core';
import { environment } from '/IT-Portal/IT-Portal/IT-Portal.UI/src/environments/environment';
import * as Chart from 'chart.js';
import { Color } from '@swimlane/ngx-charts';
import { ChartData,ChartDataset, ChartType, ChartOptions } from 'chart.js';




@Component({
  selector: 'app-dashboard',
  templateUrl: './dashboard.component.html',
  styleUrl: './dashboard.component.css',
})


export class DashboardComponent implements OnInit {

 
  constructor(private http: HttpClient) {
}

  private apiurl = environment.apiurls

  single: any;
  ngOnInit(): void {
    this.getchangerequest();
    this.Getbarchart();
    this.Gettablechart();
  }

  openNav() {
    const mySidenav = document.getElementById('mySidenav');
    if (mySidenav) {
      mySidenav.style.width = '250px';
    }
  }

  closeNav() {
    const mySidenav = document.getElementById('mySidenav');
    if (mySidenav) {
      mySidenav.style.width = '0';
    }
  }
  // Filter
  isVisible = false;

  toggleVisibility() {
    this.isVisible = !this.isVisible;
  }

  // Charts
 
  //API Call for change request
  changerequest: any[] = [];
  newCount: number = 0;
  completedCount: number = 0;
  pendingCount: number = 0;
  pendingApproval: number = 0;
  Approved: number = 0;
  Rejected: number = 0;
  Implemention: number = 0;
  pending: number = 0;
  release: number = 0;
  Closure: number = 0;
  doughnutChartData: ChartData<"doughnut", number[], string>[] | undefined;
  getchangerequest() {
    const apiUrls = this.apiurl + '/ViewChange/GetAllchanges';
    const requestBody = {}

    const httpOptions = {
      headers: new HttpHeaders({
        'content-Type': 'application/json'
      })
    };

    this.http.get(apiUrls, requestBody).subscribe(
      (response: any) => {
        this.changerequest = response;
      /*  this.countStatus();*/
       
      },
       
      (error) => {
        console.error("Post failed", error);
      }
    );
  }
 
  countStatus() {
    this.newCount = this.changerequest.filter(item => item.status.trim() === 'Draft').length;
    this.completedCount = this.changerequest.filter(item => item.status.trim() === 'Completed').length;
    this.pendingCount = this.changerequest.filter(item => item.status.trim() === 'Approved level1').length;
    this.pendingApproval = this.changerequest.filter(item => item.status.trim() === 'Pending Approval').length;
    this.Approved = this.changerequest.filter(item => item.status.trim() === 'Approved').length;
    this.Rejected = this.changerequest.filter(item => item.status.trim() === 'Rejected').length;
    this.Implemention = this.changerequest.filter(item => item.status.trim() === 'Implement').length;
    this.pending = this.changerequest.filter(item => item.status.trim() === 'Pending').length;
    this.release = this.changerequest.filter(item => item.status.trim() === 'Release').length;


    this.doughnutChartData = [{
      data: [
        this.newCount,
        this.pendingApproval,
        this.Approved,
        this.Rejected,
        this.Implemention,
        this.pending,
        this.release,
        this.completedCount
      ],
      label: 'Sales',
      backgroundColor: [
        '#3B71CA',
        '#808080ff',
        '#14A44D',
        '#DC4C64',
        '#54B4D3',
        '#E4A11B',
        '#b5eb49',
        '#808080ff'
      ]
    }];


    
  }
  /*labels: this.doughnutChartLabels,
  datasets: [
    {
       this.doughnutChartData =[
      {
        data: [
          this.newCount,
          this.pendingApproval,
          this.Approved,
          this.Rejected,
          this.Implemention,
          this.pending,
          this.release,
          this.completedCount
        ],
      label: 'Sales',
      backgroundColor: [
        '#3B71CA',
        '#808080ff',
        '#14A44D',
        '#DC4C64',
        '#54B4D3',
        '#E4A11B',
        '#b5eb49',
        '#808080ff'
      ],
    }
  ]

 */
  getdata() {
    alert(this.pendingCount)
    /*console.log("getting data", this.changerequest)*/
  }

  /*getdata() {
    alert("completed "+this.completedCount)
  }*/
  chartdata: any;
  completed: any[]=[];
  noncompleted: any[]=[];
  month: any[] = [];
  barchartdata: any[] = [];
  barChartLabels: string[] = [];
  
  Getbarchart() {
    const apiUrls = this.apiurl + '/Barchart/Getbarchart';
    

    const httpOptions = {
      headers: new HttpHeaders({
        'content-Type': 'application/json'
      })
    };

    this.http.get(apiUrls).subscribe(
      (response: any) => {
        this.chartdata = response;

        this.completed = response.map((item: { completedIdnum: any; }) => item.completedIdnum);
        this.noncompleted = response.map((item: { nonCompletedIdnum: any; }) => item.nonCompletedIdnum);
        const month = response.map((item: { crmonth: any }) => item.crmonth);
        this.updateBarChartLabels(month);
        this.updateBarChartData(month)
 
      }, 
      (error) => {
        console.log("Post failed", error);
      }
    );
  }
  /*Chart tabs*/
  public barChartOptions: any = {
    scaleShowVerticalLines: false,
    responsive: true
  };
  /*public barChartLabels = this.updateBarChartLabels(this.month);*/
  public barChartType: Chart.ChartType = 'bar';
  public barChartLegend = true;
  public barChartPlugins = [];
  public barChartData = [
    { data: this.noncompleted, label: 'Open' },
    { data: this.completed, label: 'Completed' },
   
   ] 

  // events
  public chartClicked(e: any): void {
    // console.log(e);
  }

  updateBarChartData(month: number[]) {
   
    this.barChartData = [
      { data: this.noncompleted, label: 'Open' },
      { data: this.completed, label: 'Completed' }
    ];

   /* Update chart labels*/
    this.updateBarChartLabels(month);
  }
  updateBarChartLabels(month: number[]) {
  
    this.barChartLabels = month.map(month => this.getMonthName(month));
  }
  getMonthName(month: number): string {
    const monthNames = ["January", "Feb", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    return monthNames[month - 1];
  }


  /*donut chart*/
  public doughnutChartLabels: string[] = ['Draft', 'Pending Approval', 'Approved', 'Rejected', 'Implementation', 'Pending', 'Release', 'Closure'];
  /*public doughnutChartData: ChartData<"doughnut", number[], string> = {
    labels: this.doughnutChartLabels,
    datasets: [
      {
        data: [350, 450, 100, 333, 156],
        label: 'Sales',
        backgroundColor: [
          'rgba(255, 99, 132, 0.5)',   // Red
          '#14A44D',    // Blue
          'rgba(255, 205, 86, 0.5)',    // Yellow
          'rgba(75, 192, 192, 0.5)'     // Green
        ],
      }
    ]
  };*/
  public doughnutChartType: ChartType = 'doughnut';


  public chartHovered(e: any): void {
    // console.log(e);
  }


  /*tablechart*/
  plant: any;
  approval: any[] = [];
  closure: any[] = [];
  implementation: any[] = [];
  initiated: any[] = [];
  Release:any[]=[];
  Gettablechart() {
    const apiUrls = this.apiurl + '/ViewChange/GetAllchanges';

    const httpOptions = {
      headers: new HttpHeaders({
        'content-Type': 'application/json'
      })
    };

    this.http.get(apiUrls).subscribe(
      (response: any) => {
        this.chartdata = response;
        this.approval = response.filter((item: { stage: string; }) => item.stage.trim() === 'Approval').length;
        this.closure = response.filter((item: { stage: string; }) => item.stage.trim() === 'Closure').length;
        this.implementation = response.filter((item: { stage: string; }) => item.stage.trim() === 'Implementation').length;
        this.initiated = response.filter((item: { stage: string; }) => item.stage.trim() === 'Initiated').length;
        this.Release = response.filter((item: { stage: string; }) => item.stage.trim() === 'Release').length;
        this.plant = response.map((item: { plantId: any }) => item.plantId);
      

        // Create multi array
        this.multi = this.plant.map((plantId: any) => {
          const name = plantId.split(' ')[0]; // Splitting plantId assuming it's a string and taking the first part
          return {
            name: name,
            series: [
              { name: 'Approval', value: this.approval },
              { name: 'Closure', value: this.closure },
              { name: 'Implementation', value: this.implementation },
              { name: 'Initiated', value: this.initiated },
              { name: 'Release', value: this.Release }
            ]
          };
        
        });
        

        // Merge with existing data in this.multi
        this.multi.forEach((item, index) => {
          const existingItemIndex = this.multi.findIndex((el) => el.name === item.name);
          if (existingItemIndex !== -1) {
            this.multi[existingItemIndex] = { ...item, series: this.multi[existingItemIndex].series };
          } else {
            this.multi.push({
              name: item.name,
              series: [
                { name: 'Approval', value: this.approval },
                { name:'Closure', value:this.closure },
                { name:'Implementation',value:this.implementation },
                { name:'Initiated',value:this.initiated },
                { name:'Release',value:this.Release }]
            });
          }
        });

        console.log('multi:', this.multi);
      },
      (error) => {
        console.log("Post failed", error);
      }
    );
  }


  /*table chart*/
  multi: any[]=[];
  view: [number, number] = [350, 205];
  
  showXAxis: boolean = true;
  showYAxis: boolean = true;
  gradient: boolean = false;
  showLegend: boolean = false;
  showXAxisLabel: boolean = true;
  xAxisLabel: string = 'Total Changes';
  showYAxisLabel: boolean = true;
  yAxisLabel: string = 'Plants';
  showDataLabel = false;
  colorScheme!: {
    domain: ['#14A44D', '#808080ff', '#54B4D3','#DC4C64','#b5eb49'];
    };


  onSelect(event: any) {
    console.log(event);
  }

  axisFormat(val: any) {
    return val;
  }

  

 
 


  

  



 

  

}
